<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="holo-category-data">
  <script>
    (function () {
      const catalog = {};
      const requests = {};

      window.catalog = catalog;

      class HoloCategoryData extends Polymer.Element {

        static get is() { return 'holo-category-data'; }

        static get properties() { return {

          language: {
            type: String,
            observer: '_languageChanged'
          },

          catalog: {
            type: Object,
            value: catalog
          },

          categoryName: String,

          itemName: String,

          categories: {
            type: Array,
            // computed: '_computeCategories(language)',
            // readOnly: true,
            notify: true,
            value: []
          },

          category: {
            type: Object,
            computed: '_computeCategory(categories.*, categoryName)',
            notify: true
          },

          item: {
            type: Object,
            computed: '_computeItem(category.items, itemName)',
            notify: true
          },

          failure: {
            type: Boolean,
            notify: true,
            readOnly: true
          }

        }}

        _languageChanged(language) {
          //this.unlinkPaths('categories');
          if (!this.catalog[language]) {
            this.catalog[language] = [];
            this._fetchCategories(language, 1);
          }
          //this.linkPaths('categories', 'catalog.' + language);
          this.set('categories', this.catalog[language]);
        }

        _computeCategories(language) {
          if (!this.catalog[language]) {
            this.catalog[language] = [];
          }
          this._fetchCategories(language, 1);
          return this.catalog[language];
        }

        _fetchCategories(language, attempts) {
          this._setFailure(false);
          if (this.catalog[language] && this.catalog[language].length > 0) {
            return;
          }
          this._getResource({
            url: 'data/' + language + '/categories.json',
            onLoad(e) {
              if (e.target.status === 200) {
                JSON.parse(e.target.responseText).forEach(category => this.push('categories', category));
              } else {
                this._setFailure(true);
              }
            },
            onError(e) {
              this._setFailure(true);
            }
          })
        }

        _getCategoryObject(categories, categoryName) {
          if (!categories || !categoryName) {
            return;
          }
          for (let i = 0, c; c = this.categories[i]; ++i) {
            if (c.name === categoryName) {
              return c;
            }
          }
        }

        _computeCategory(categories, categoryName) {
          console.log(JSON.stringify(this.categories), categoryName);
          let category = this._getCategoryObject(this.categories, categoryName);
          this._fetchItems(this.language, category, 1);
          return category;
        }

        _computeItem(items, itemName) {
          if (!items || !itemName) {
            return;
          }
          for (let i = 0, item; item = items[i]; ++i) {
            if (item.name === itemName) {
              return item;
            }
          }
        }

        _fetchItems(language, category, attempts) {
          this._setFailure(false);
          if (!category || category.items) {
            return;
          }
          this._getResource({
            url: 'data/' + language + '/' + category.name + '.json',
            onLoad(e) {
              if (e.target.status === 200) {
                this.set('category.items', JSON.parse(e.target.responseText));
              } else {
                this._setFailure(true);
              }
            },
            onError(e) {
              this._setFailure(true);
            }
          }, attempts);
        }

        _getResource(rq, attempts) {
          if (requests[rq.url]) {
            return;
          }
          const xhr = new XMLHttpRequest();
          xhr.addEventListener('load', rq.onLoad.bind(this));
          xhr.addEventListener('error', (e) => {
            requests[rq.url] = false;
            if (attempts > 1) {
              this._getResourceDebouncer = Polymer.Debouncer.debounce(this._getResourceDebouncer,
                Polymer.Async.timeOut.after(200), this._getResource.bind(this, rq, attempts - 1));
            } else {
              rq.onError.call(this, e);
            }
          });

          xhr.open('GET', rq.url);
          xhr.send();
          requests[rq.url] = true;
        }

        refresh() {
          this._fetchCategories(this.language, 3);
          if (this.categoryName) {
            this._fetchItems(this.language, this._getCategoryObject(this.categoryName), 3);
          }
        }

      }

      customElements.define(HoloCategoryData.is, HoloCategoryData);

    })();
  </script>
</dom-module>
